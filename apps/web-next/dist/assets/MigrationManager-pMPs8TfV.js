import{r as p,j as e,c as i}from"./index-DpHBJgBc.js";const r=[{id:"m001",version:"20260120001",name:"create_agents_table",type:"schema",status:"applied",appliedAt:"2026-01-20T09:00:00Z",duration:142,author:"Sam",description:"Create the core agents table with UUID primary key, name, model, config JSONB, and timestamps",upSql:`CREATE TABLE agents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  model TEXT NOT NULL,
  config JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);`,downSql:"DROP TABLE agents;",affectedTables:["agents"],reversible:!0,checksum:"a1b2c3d4",environment:["dev","staging","production"]},{id:"m002",version:"20260122001",name:"create_sessions_table",type:"schema",status:"applied",appliedAt:"2026-01-22T10:15:00Z",duration:89,author:"Sam",description:"Create sessions table with FK to agents, status enum, and message history JSONB",upSql:`CREATE TYPE session_status AS ENUM ('active', 'idle', 'closed', 'error');
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  agent_id UUID NOT NULL REFERENCES agents(id) ON DELETE CASCADE,
  status session_status DEFAULT 'active',
  context JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW()
);`,downSql:`DROP TABLE sessions;
DROP TYPE session_status;`,affectedTables:["sessions"],reversible:!0,checksum:"e5f6a7b8",environment:["dev","staging","production"]},{id:"m003",version:"20260128001",name:"add_agents_org_id",type:"schema",status:"applied",appliedAt:"2026-01-28T14:30:00Z",duration:67,author:"Reed",description:"Add org_id column to agents for multi-tenant support",upSql:`ALTER TABLE agents ADD COLUMN org_id UUID REFERENCES organizations(id);
CREATE INDEX idx_agents_org_id ON agents(org_id);`,downSql:`DROP INDEX idx_agents_org_id;
ALTER TABLE agents DROP COLUMN org_id;`,affectedTables:["agents"],reversible:!0,checksum:"c9d0e1f2",environment:["dev","staging","production"]},{id:"m004",version:"20260201001",name:"create_model_invocations_table",type:"schema",status:"applied",appliedAt:"2026-02-01T08:00:00Z",duration:201,author:"Sam",description:"High-volume invocations table with partitioning by month for performance",upSql:`CREATE TABLE model_invocations (
  id UUID NOT NULL,
  session_id UUID NOT NULL REFERENCES sessions(id),
  model TEXT NOT NULL,
  input_tokens INT,
  output_tokens INT,
  latency_ms INT,
  cost_usd NUMERIC(10,6),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
) PARTITION BY RANGE (created_at);`,downSql:"DROP TABLE model_invocations;",affectedTables:["model_invocations"],reversible:!0,checksum:"g3h4i5j6",environment:["dev","staging","production"]},{id:"m005",version:"20260205001",name:"backfill_agent_display_names",type:"data",status:"applied",appliedAt:"2026-02-05T11:45:00Z",duration:4320,author:"Luis",description:"Backfill display_name from legacy name column, trimming whitespace and applying title case",upSql:`UPDATE agents
SET display_name = initcap(trim(name))
WHERE display_name IS NULL;`,downSql:"-- Not reversible: original data preserved in name column",affectedTables:["agents"],reversible:!1,checksum:"k7l8m9n0",environment:["staging","production"]},{id:"m006",version:"20260210001",name:"add_webhook_delivery_index",type:"index",status:"applied",appliedAt:"2026-02-10T03:00:00Z",duration:8940,author:"Sam",description:"Add composite index on webhook_deliveries (webhook_id, status, created_at) for faster delivery log queries",upSql:`CREATE INDEX CONCURRENTLY idx_webhook_deliveries_composite
ON webhook_deliveries(webhook_id, status, created_at DESC);`,downSql:"DROP INDEX CONCURRENTLY idx_webhook_deliveries_composite;",affectedTables:["webhook_deliveries"],reversible:!0,checksum:"o1p2q3r4",environment:["dev","staging","production"]},{id:"m007",version:"20260215001",name:"add_sessions_context_search",type:"index",status:"applied",appliedAt:"2026-02-15T04:00:00Z",duration:12100,author:"Quinn",description:"Add GIN index on sessions.context JSONB for fast key lookups",upSql:`CREATE INDEX CONCURRENTLY idx_sessions_context_gin
ON sessions USING GIN(context);`,downSql:"DROP INDEX CONCURRENTLY idx_sessions_context_gin;",affectedTables:["sessions"],reversible:!0,checksum:"s5t6u7v8",environment:["dev","staging","production"]},{id:"m008",version:"20260218001",name:"add_agent_soft_delete",type:"schema",status:"applied",appliedAt:"2026-02-18T09:00:00Z",duration:154,author:"Reed",description:"Add deleted_at timestamp for soft deletes on agents table",upSql:`ALTER TABLE agents ADD COLUMN deleted_at TIMESTAMPTZ;
CREATE INDEX idx_agents_deleted_at ON agents(deleted_at) WHERE deleted_at IS NOT NULL;`,downSql:`DROP INDEX idx_agents_deleted_at;
ALTER TABLE agents DROP COLUMN deleted_at;`,affectedTables:["agents"],reversible:!0,checksum:"w9x0y1z2",environment:["dev","staging","production"]},{id:"m009",version:"20260222001",name:"add_invocation_error_column",type:"schema",status:"pending",author:"Sam",description:"Add structured error JSONB column to model_invocations for better failure analysis",upSql:`ALTER TABLE model_invocations ADD COLUMN error_details JSONB;
COMMENT ON COLUMN model_invocations.error_details IS 'Structured error info: {code, message, retryable}';`,downSql:"ALTER TABLE model_invocations DROP COLUMN error_details;",affectedTables:["model_invocations"],reversible:!0,checksum:"a3b4c5d6",environment:["dev","staging","production"]},{id:"m010",version:"20260222002",name:"create_cost_allocations_table",type:"schema",status:"pending",author:"Quinn",description:"New table for tracking cost attribution by org, project, and agent",upSql:`CREATE TABLE cost_allocations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  agent_id UUID REFERENCES agents(id),
  model TEXT NOT NULL,
  period DATE NOT NULL,
  tokens_used BIGINT DEFAULT 0,
  cost_usd NUMERIC(12,6) DEFAULT 0,
  UNIQUE(org_id, agent_id, model, period)
);`,downSql:"DROP TABLE cost_allocations;",affectedTables:["cost_allocations"],reversible:!0,checksum:"e7f8g9h0",environment:["dev","staging","production"]},{id:"m011",version:"20260222003",name:"migrate_legacy_webhook_format",type:"data",status:"pending",author:"Sam",description:"Transform legacy webhook payload format from v1 to v2 schema (adds envelope wrapper)",upSql:`UPDATE webhook_deliveries
SET payload = jsonb_build_object(
  'version', 2,
  'event', payload->'event',
  'data', payload->'data',
  'timestamp', payload->>'timestamp'
)
WHERE (payload->>'version')::int < 2 OR payload->>'version' IS NULL;`,downSql:"-- Version downgrade not supported for data migrations",affectedTables:["webhook_deliveries"],reversible:!1,checksum:"i1j2k3l4",environment:["dev"]}],j=[{id:"run-3",startedAt:"2026-02-18T09:00:00Z",completedAt:"2026-02-18T09:00:04Z",migrationsApplied:1,migrationsSkipped:7,migrationsFailed:0,environment:"production",triggeredBy:"Reed",log:["[09:00:00] Connecting to postgres://prod-db.internal:5432/clawdbot","[09:00:00] Running migration check...","[09:00:00] 7 migrations already applied","[09:00:00] 1 pending migration found","[09:00:00] â–¶ Applying 20260218001_add_agent_soft_delete...","[09:00:04] âœ“ Applied in 154ms","[09:00:04] âœ“ All migrations up to date"]},{id:"run-2",startedAt:"2026-02-15T04:00:00Z",completedAt:"2026-02-15T04:00:16Z",migrationsApplied:1,migrationsSkipped:6,migrationsFailed:0,environment:"production",triggeredBy:"deploy-bot",log:["[04:00:00] Connecting to postgres://prod-db.internal:5432/clawdbot","[04:00:00] 6 migrations already applied, 1 pending","[04:00:00] â–¶ Applying 20260215001_add_sessions_context_search...","[04:00:16] âœ“ Applied in 12.1s (CONCURRENTLY)"]}],c={applied:{label:"Applied",color:"text-emerald-400",bg:"bg-emerald-900/30 border-emerald-800",icon:"âœ…"},pending:{label:"Pending",color:"text-amber-400",bg:"bg-amber-900/30 border-amber-800",icon:"â³"},failed:{label:"Failed",color:"text-rose-400",bg:"bg-rose-900/30 border-rose-800",icon:"âŒ"},"rolled-back":{label:"Rolled Back",color:"text-zinc-400",bg:"bg-zinc-800 border-zinc-700",icon:"â†©ï¸"},running:{label:"Running",color:"text-sky-400",bg:"bg-sky-900/30 border-sky-800",icon:"ðŸ”„"}},m={schema:{label:"Schema",color:"text-indigo-400",icon:"ðŸ—‚ï¸"},data:{label:"Data",color:"text-sky-400",icon:"ðŸ“¦"},index:{label:"Index",color:"text-purple-400",icon:"ðŸ”"},constraint:{label:"Constraint",color:"text-orange-400",icon:"ðŸ”—"},seed:{label:"Seed",color:"text-teal-400",icon:"ðŸŒ±"}};function y(){const[x,h]=p.useState("migrations"),[n,N]=p.useState(null),[b,v]=p.useState("all"),[d,u]=p.useState(null),[o,T]=p.useState(null),_=r.filter(t=>t.status==="applied").length,l=r.filter(t=>t.status==="pending").length;r.filter(t=>t.status==="failed").length;const E=r.filter(t=>b==="all"||t.status===b),f=[{id:"migrations",label:"ðŸ“‹ Migrations"},{id:"runs",label:"â–¶ Run History"},{id:"schema",label:"ðŸ—‚ï¸ Schema Info"}];return e.jsxs("div",{className:"min-h-screen bg-zinc-950 text-white p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Migration Manager"}),e.jsx("p",{className:"text-zinc-400 text-sm mt-1",children:"Database migration tracking â€” clawdbot PostgreSQL"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("div",{className:i("px-3 py-1.5 text-sm rounded-lg border font-mono",l>0?"border-amber-800 text-amber-400 bg-amber-900/20":"border-emerald-800 text-emerald-400 bg-emerald-900/20"),children:l>0?`${l} pending`:"âœ… Up to date"})})]}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[{label:"Applied",value:_,color:"text-emerald-400",bg:"border-emerald-900 bg-emerald-900/10"},{label:"Pending",value:l,color:"text-amber-400",bg:"border-amber-900 bg-amber-900/10"},{label:"Total",value:r.length,color:"text-white",bg:"border-zinc-800 bg-zinc-900/50"}].map(t=>e.jsxs("div",{className:i("border rounded-lg p-4",t.bg),children:[e.jsx("div",{className:i("text-3xl font-bold",t.color),children:t.value}),e.jsx("div",{className:"text-xs text-zinc-500 mt-0.5",children:t.label})]},t.label))})]}),e.jsx("div",{className:"flex gap-1 border-b border-zinc-800 mb-5",children:f.map(t=>e.jsx("button",{onClick:()=>h(t.id),className:i("px-4 py-2 text-sm font-medium rounded-t-lg transition-colors",x===t.id?"text-white bg-zinc-800 border border-b-0 border-zinc-700":"text-zinc-400 hover:text-white"),children:t.label},t.id))}),x==="migrations"&&e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-1 mb-4",children:["all","applied","pending","failed"].map(t=>e.jsxs("button",{onClick:()=>v(t),className:i("px-3 py-1 text-xs rounded-lg border transition-colors",b===t?"bg-zinc-700 border-zinc-600 text-white":"border-zinc-800 text-zinc-500 hover:text-white"),children:[t==="all"?"All":c[t].label,e.jsxs("span",{className:"ml-1 text-zinc-600",children:["(",t==="all"?r.length:r.filter(s=>s.status===t).length,")"]})]},t))}),e.jsx("div",{className:"space-y-2",children:E.map(t=>e.jsxs("div",{onClick:()=>N((n==null?void 0:n.id)===t.id?null:t),className:i("bg-zinc-900 border rounded-lg p-4 cursor-pointer transition-colors",(n==null?void 0:n.id)===t.id?"border-indigo-600":"border-zinc-800 hover:border-zinc-700"),children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"text-lg shrink-0 mt-0.5",children:c[t.status].icon}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap mb-1",children:[e.jsx("span",{className:"font-mono text-xs text-zinc-500",children:t.version}),e.jsx("span",{className:i("text-xs px-2 py-0.5 rounded border",c[t.status].color,c[t.status].bg),children:c[t.status].label}),e.jsxs("span",{className:i("text-xs",m[t.type].color),children:[m[t.type].icon," ",m[t.type].label]}),!t.reversible&&e.jsx("span",{className:"text-xs text-orange-400",children:"âš ï¸ Irreversible"}),e.jsxs("span",{className:"text-xs text-zinc-500 ml-auto",children:["by ",t.author]})]}),e.jsx("div",{className:"font-mono text-sm text-white",children:t.name}),e.jsx("div",{className:"text-xs text-zinc-500 mt-0.5",children:t.description}),e.jsxs("div",{className:"flex items-center gap-4 mt-1 text-xs text-zinc-600",children:[t.appliedAt&&e.jsxs("span",{children:["Applied ",new Date(t.appliedAt).toLocaleDateString()]}),t.duration&&e.jsxs("span",{children:["â±ï¸ ",t.duration>=1e3?`${(t.duration/1e3).toFixed(1)}s`:`${t.duration}ms`]}),e.jsxs("span",{children:["Tables: ",t.affectedTables.join(", ")]})]})]})]}),(n==null?void 0:n.id)===t.id&&e.jsxs("div",{className:"mt-4 border-t border-zinc-800 pt-4 space-y-3",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("button",{onClick:()=>u(d==="up"?null:"up"),className:i("px-3 py-1.5 text-xs rounded-lg border transition-colors",d==="up"?"bg-indigo-600 border-indigo-500 text-white":"border-zinc-700 text-zinc-400 hover:text-white"),children:"â–² UP Migration SQL"}),t.reversible&&e.jsx("button",{onClick:()=>u(d==="down"?null:"down"),className:i("px-3 py-1.5 text-xs rounded-lg border transition-colors",d==="down"?"bg-rose-700 border-rose-600 text-white":"border-zinc-700 text-zinc-400 hover:text-white"),children:"â–¼ DOWN (Rollback) SQL"})]}),d&&e.jsx("pre",{className:"bg-zinc-950 border border-zinc-800 rounded-lg p-4 text-xs font-mono text-emerald-300 overflow-x-auto whitespace-pre",children:d==="up"?t.upSql:t.downSql}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 text-xs",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-zinc-500 mb-1",children:"Checksum"}),e.jsx("div",{className:"font-mono text-zinc-300",children:t.checksum})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-zinc-500 mb-1",children:"Environments"}),e.jsx("div",{className:"flex gap-1 flex-wrap",children:t.environment.map(s=>e.jsx("span",{className:"text-xs px-1.5 py-0.5 rounded bg-zinc-800 text-zinc-300",children:s},s))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-zinc-500 mb-1",children:"Reversible"}),e.jsx("div",{className:t.reversible?"text-emerald-400":"text-rose-400",children:t.reversible?"âœ… Yes":"âŒ No"})]})]}),t.status==="pending"&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx("button",{className:"px-4 py-1.5 text-sm bg-indigo-600 hover:bg-indigo-500 rounded-lg text-white transition-colors",children:"â–¶ Apply Migration"}),e.jsx("button",{className:"px-4 py-1.5 text-sm bg-zinc-800 hover:bg-zinc-700 rounded-lg text-zinc-300 transition-colors",children:"Dry Run"})]}),t.status==="applied"&&t.reversible&&e.jsx("button",{className:"px-4 py-1.5 text-sm border border-rose-800 hover:bg-rose-900/30 rounded-lg text-rose-400 transition-colors",children:"â†©ï¸ Rollback This Migration"})]})]},t.id))})]}),x==="runs"&&e.jsxs("div",{className:"space-y-4",children:[l>0&&e.jsxs("div",{className:"bg-amber-900/20 border border-amber-900 rounded-lg p-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-semibold text-amber-300",children:[l," pending migrations"]}),e.jsx("div",{className:"text-xs text-zinc-400 mt-0.5",children:"Run migrations to bring the database up to date"})]}),e.jsx("button",{className:"px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-sm font-medium text-white transition-colors",children:"â–¶ Run Pending"})]}),j.map(t=>e.jsxs("div",{onClick:()=>T((o==null?void 0:o.id)===t.id?null:t),className:i("bg-zinc-900 border rounded-lg p-4 cursor-pointer transition-colors",(o==null?void 0:o.id)===t.id?"border-indigo-600":"border-zinc-800 hover:border-zinc-700"),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-emerald-400 font-bold",children:"âœ“"}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-white",children:[t.migrationsApplied," applied, ",t.migrationsSkipped," skipped"]}),e.jsxs("div",{className:"text-xs text-zinc-500",children:[new Date(t.startedAt).toLocaleString()," Â· ",t.environment," Â· by ",t.triggeredBy]})]})]}),e.jsx("span",{className:"text-xs text-zinc-500",children:t.id})]}),(o==null?void 0:o.id)===t.id&&e.jsx("div",{className:"mt-3 bg-zinc-950 border border-zinc-800 rounded-lg p-3 font-mono text-xs space-y-0.5",children:t.log.map((s,g)=>e.jsx("div",{className:i("",s.includes("âœ“")?"text-emerald-400":s.includes("â–¶")?"text-indigo-400":"text-zinc-500"),children:s},g))})]},t.id))]}),x==="schema"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-zinc-400 mb-4",children:"Tables touched by tracked migrations"}),Array.from(new Set(r.flatMap(t=>t.affectedTables))).map(t=>{const s=r.filter(a=>a.affectedTables.includes(t)),g=s.filter(a=>a.status==="applied").sort((a,A)=>A.version>a.version?1:-1)[0];return e.jsxs("div",{className:"bg-zinc-900 border border-zinc-800 rounded-lg p-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-mono text-white text-sm",children:t}),e.jsxs("div",{className:"text-xs text-zinc-500 mt-0.5",children:[s.length," migrations Â· last modified ",g?new Date(g.appliedAt).toLocaleDateString():"never"]})]})}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.map(a=>e.jsxs("div",{className:"flex items-center gap-1.5 bg-zinc-800 rounded px-2 py-1 text-xs",children:[e.jsx("span",{children:c[a.status].icon}),e.jsx("span",{className:"font-mono text-zinc-300",children:a.name}),e.jsx("span",{className:i(m[a.type].color),children:m[a.type].icon})]},a.id))})]},t)})]})]})}export{y as default};
