import{r as t}from"./index-Bp6H_MEW.js";const G="ws://localhost:18789",N=1e3,O=3e4,W=5e3;function v(){const[d,a]=t.useState("disconnected"),[p,y]=t.useState(null),o=t.useRef(null),l=t.useRef(new Map),k=t.useRef(1),u=t.useRef(void 0),i=t.useRef(0),E=t.useRef(!1),w=t.useRef(!1),g=t.useCallback(()=>k.current++,[]),f=t.useCallback(r=>{const e=l.current.get(r);e&&(clearTimeout(e.timeout),l.current.delete(r))},[]),C=t.useCallback(r=>{try{const e=JSON.parse(r.data);if(e.type==="hello"){console.log("[Gateway] Received hello:",e),E.current=!0,a("connected"),y(null),i.current=0;return}const n=e;if(typeof n.id=="number"){const c=l.current.get(n.id);c?(f(n.id),n.ok?c.resolve(n.result):c.reject(new Error(n.error||"Unknown error"))):console.warn("[Gateway] Received response for unknown call ID:",n.id)}}catch(e){console.error("[Gateway] Failed to parse message:",e)}},[f]),s=t.useCallback(()=>{var r;if(((r=o.current)==null?void 0:r.readyState)!==WebSocket.OPEN){w.current=!1,a("connecting"),E.current=!1;try{const e=new WebSocket(G);o.current=e,e.onopen=()=>{console.log("[Gateway] WebSocket connected, waiting for hello..."),setTimeout(()=>{E.current||(console.warn("[Gateway] Hello timeout, proceeding anyway"),a("connected"))},W)},e.onmessage=C,e.onerror=()=>{console.error("[Gateway] WebSocket error"),y("Connection error"),a("error")},e.onclose=()=>{if(console.log("[Gateway] WebSocket closed"),o.current=null,!w.current){a("disconnected");const n=Math.min(N*Math.pow(2,i.current),O);i.current++,console.log(`[Gateway] Reconnecting in ${n}ms (attempt ${i.current})`),u.current=setTimeout(s,n)}}}catch(e){console.error("[Gateway] Failed to create WebSocket:",e),y(e instanceof Error?e.message:"Connection failed"),a("error")}}},[C]),S=t.useCallback(()=>{u.current&&clearTimeout(u.current),o.current&&(w.current=!0,o.current.close(),o.current=null),i.current=0,s()},[s]),b=t.useCallback(async(r,e)=>new Promise((n,c)=>{if(!o.current||o.current.readyState!==WebSocket.OPEN){d!=="connecting"&&s(),c(new Error("Not connected to Gateway"));return}const m=g(),h={id:m,method:r,params:e},T=setTimeout(()=>{f(m),c(new Error(`Call timeout: ${r}`))},3e4);l.current.set(m,{resolve:R=>n(R),reject:c,timeout:T});try{o.current.send(JSON.stringify(h))}catch(R){f(m),c(R)}}),[d,s,g,f]);return t.useEffect(()=>(s(),()=>{w.current=!0,u.current&&clearTimeout(u.current),o.current&&o.current.close(),l.current.forEach(r=>{clearTimeout(r.timeout),r.reject(new Error("Connection closed"))}),l.current.clear()}),[s]),{connectionState:d,call:b,isConnected:d==="connected",lastError:p,reconnect:S}}export{v as u};
